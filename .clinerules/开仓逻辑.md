好的，我将K线数据的具体返回格式和说明补充到文档的相应位置。

---

## 量化交易策略：开仓核心逻辑与执行规范

本文档阐述了量化交易策略中，所有开仓操作所需遵循的基础逻辑、执行流程及相关规范。

### 一、开仓核心逻辑流程

1.  **数据准备与处理：**
    *   获取所有账户共享的 K 线数据及最新合约收盘价。
    *   **K线数据格式：** K线数据通过类似以下JSON格式返回：
        ```json
        {
          "code": "0",
          "msg": "",
          "data": [
            [
              "1752102300000",  // 时间戳
              "2838.19",        // 开盘价
              "2839",           // 最高价
              "2837.61",        // 最低价
              "2839",           // 收盘价
              "16229.89",       // 交易量
              "1622.989",       // 交易量（以币为单位）
              "4606999.23978",  // 交易额
              "0"               // K线状态：0未完结，1已完结
            ],
            [
              "1752102000000", "2860.54", "2862.35", "2835.67", "2837.98", "2027246.81", "202724.681", "576948752.81839", "1"
            ]
          ]
        }
        ```
        其中，`data` 字段是一个包含多根K线数据的列表，每根K线数据又是一个小列表。每个小列表（即单根K线数据）的**最后一个参数**表示K线状态：`0` 代表K线未完结（通常是最新生成的K线），`1` 代表K线已完结。
    *   **K线数据状态判断：** 系统通过青龙面板每5分钟运行一次。在进行K线形态判断时，**必须使用状态为 `1` 的已完结K线**（通常是最新已完结的一根）进行分析。状态为 `0` 的K线不具备参考价值，应被忽略。

2.  **现有委托检查与处理：**
    *   对每个交易账户，在发起新开仓前，首先检查是否存在未成交的开仓委托。
    *   **多头委托：** 若当前合约最新价已超过该委托的止盈价，则立即撤销该委托，并继续评估当前开仓信号。
    *   **空头委托：** 若当前合约最新价已低于该委托的止盈价，则立即撤销该委托，并继续评估当前开仓信号。
    *   若无任何现有开仓委托，则进入下一步开仓信号判断。

3.  **开仓信号判断与执行：**
    *   基于已确认的K线形态，判断是否符合预设的开仓条件。
    *   若信号符合，准备所有必要的下单参数，包括但不限于：订单ID、开仓价格、开仓数量、开仓方向、止盈止损参数等。
    *   执行下单操作。下单完成后，通过Bark服务发送通知。

### 二、开发与操作规范

4.  **日志规范：**
    *   所有关键步骤，尤其是开仓请求的原始JSON参数和服务器返回的JSON响应，均需记录详细日志，以便进行操作追踪与问题排查。

5.  **计算结果输出：**
    *   即使没有生成开仓信号，程序也应计算并输出基于最新收盘价的潜在下单数量至控制台，以供观察。

6.  **代码复用原则：**
    *   在编写策略主程序前，务必仔细阅读并尽可能复用 `utils/okx_utils` 文件中的现有函数，避免代码冗余。

7.  **多账户支持与配置：**
    *   系统需支持多OKX账户操作。所有账户配置（如API Key、Secret Key、Passphrase、账户名、杠杆倍数等）应通过环境变量进行管理（示例格式见下）。
    *   代码应适配多账户，确保所有日志和Bark通知中明确显示是哪个账户正在执行操作。
    *   **环境变量示例：**
        ```ini
        OKX1_ACCOUNT_NAME=QA1
        OKX1_API_KEY=xxx
        OKX1_SECRET_KEY=xxx
        OKX1_PASSPHRASE=xxx
        OKX1_FLAG=1
        OKX1_LEVERAGE=20

        OKX2_ACCOUNT_NAME=QA2
        OKX2_API_KEY=xxx
        OKX2_SECRET_KEY=xxx
        OKX2_PASSPHRASE=xxx
        OKX2_FLAG=1
        OKX2_LEVERAGE=20
        ```

8.  **Bark 通知格式要求：**
    *   **标题：** `[策略文件名] 信号开仓` (例如：`MyStrategy.py 信号开仓`)
    *   **正文内容（按序）：**
        *   `账户: [账户名]`
        *   `交易标的: [INST_ID]`
        *   `信号类型: [做多/做空]`
        *   `入场价格: [entry_price]` (保留4位小数)
        *   `委托数量: [size]` (保留2位小数)
        *   `保证金: [margin] USDT`
        *   `止盈价格: [take_profit_price]` (保留4位小数)
        *   `止损价格: [stop_loss_price]` (保留4位小数)
        *   `客户订单ID: [clOrdId]`
        *   `时间: [当前上海时间]`
    *   **错误信息（仅下单失败时显示）：**
        *   `⚠️ 下单失败 ⚠️`
        *   `错误: [data[0]['sMsg']]` (优先显示OKX返回的详细错误提示，若无则取sMsg字段)
    *   **服务器响应：**
        *   `服务器响应代码: [code]`
        *   `服务器响应消息: [msg]`
    *   **格式说明：**
        *   严格按照要求保留所有数值的小数位。
        *   通知中不再单独列出“下单参数”和“止盈止损参数”，相关信息已合并至正文。
        *   错误信息仅显示OKX返回的详细错误提示。
        *   保留当前时间，便于后续追溯。